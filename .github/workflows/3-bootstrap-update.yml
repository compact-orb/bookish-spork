name: 3 Bootstrap Update

on:
  workflow_dispatch:
    inputs:
      skip-sync:
        description: 'Skip Portage tree sync'
        required: false
        default: false
        type: boolean
      skip-update:
        description: 'Skip package update'
        required: false
        default: false
        type: boolean
      reconfigure:
        description: 'Reconfigure system'
        required: false
        default: false
        type: boolean
      packages:
        description: 'Only update the specified packages (space separated)'
        required: false
        type: string
  schedule:
    - cron: '15 2 * * *'

env:
  BUNNY_STORAGE_ACCESS_KEY: ${{ secrets.BUNNY_STORAGE_ACCESS_KEY }}
  BUNNY_STORAGE_CDN: ${{ secrets.BUNNY_STORAGE_CDN }}
  BUNNY_STORAGE_ENDPOINT: ${{ secrets.BUNNY_STORAGE_ENDPOINT }}
  BUNNY_STORAGE_ENDPOINT_CDN: ${{ secrets.BUNNY_STORAGE_ENDPOINT_CDN }}
  BUNNY_STORAGE_ZONE_NAME: ${{ secrets.BUNNY_STORAGE_ZONE_NAME }}
  CONFIG_PREFIX: 3
  REDESIGNED_BROCCOLI_SSH_KEY: ${{ secrets.REDESIGNED_BROCCOLI_SSH_KEY }}

jobs:
  bootstrap-update:
    name: Bootstrap Update
    runs-on: ubuntu-24.04-arm
    steps:
      - uses: actions/checkout@v4

      - name: Display Runner Info
        run: bash ./ShowRunnerInfo.sh

      - name: Set Up Gentoo
        run: sudo --preserve-env pwsh -File ./PushPullImage.ps1 -From

      - name: Configure Gentoo
        if: inputs.reconfigure
        run: sudo --preserve-env pwsh -File ./SetConfiguration.ps1

      - name: Set Up Binary Packages
        if: "!inputs.skip-update"
        run: sudo --preserve-env pwsh -File ./PushPullBinaryPackages.ps1 -From

      - name: Mount Filesystems
        if: "!inputs.skip-sync || !inputs.skip-update"
        run: sudo --preserve-env pwsh -File ./MountFilesystems.ps1

      - name: Emerge Sync
        if: "!inputs.skip-sync"
        run: sudo --preserve-env chroot /mnt/gentoo bash /mnt/BuildPackages.sh --sync

      - name: Emerge Update
        if: "!inputs.skip-update"
        continue-on-error: true
        run: |
          PACKAGES=""
          ONESHOT=""
          if [ "${{ github.event.inputs.packages }}" != "" ]; then
            PACKAGES="--packages ${{ github.event.inputs.packages }}"
            ONESHOT="--oneshot"
          fi
          sudo --preserve-env chroot /mnt/gentoo bash /mnt/BuildPackages.sh --update $PACKAGES $ONESHOT

      - name: Unmount Filesystems
        if: "!inputs.skip-sync || !inputs.skip-update"
        run: sudo --preserve-env pwsh -File ./MountFilesystems.ps1 -Unmount

      - name: Upload Gentoo Binary Packages
        if: "!inputs.skip-update"
        run: sudo --preserve-env pwsh -File ./PushPullBinaryPackages.ps1 -To

      - name: Upload Gentoo
        run: sudo --preserve-env pwsh -File ./PushPullImage.ps1 -To
